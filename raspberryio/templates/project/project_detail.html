{% extends "base.html" %}
{% load mezzanine_tags %}
{% load url from future %}
{% load profile_tags %}

{% block body_id %}project-detail{% endblock %}

{% block main %}
{% if not project.is_published %}
<div class="row">
    <div class="span12">
    {% if request.user == project.user or request.user.is_superuser %}
        <div id="publish">
            <h4>This project is saved as a draft. <a id="publish-project" href="#">Publish Now</a>
            </h4>
        </div>
    {% endif %}
    </div>
</div>
{% endif %}

<div class="row">
    <div class="span12">
        <header>
            <h2>
                {{ project.title }}
                {% if request.user == project.user or request.user.is_superuser %}
                    <a href="{% url 'project-create-edit' project.slug %}"><i class="icon-edit icon-white"></i> Edit Project</a>
                    {% if project.steps.count > 20 %}
                    <a href="{% url 'project-step-create-edit' project.slug %}"><i class="icon-plus icon-white"></i> Add Step</a>
                    {% endif %}

                    <a href="{% url 'project-delete' project.id %}" class="btn-danger warning"><i class="icon-trash icon-white"></i> Delete Project</a>
                {% endif %}
                {# Leaving in here for now. This is slated for Phase II work. #}
                {% comment %}
                <a class="follow" href="#">Follow</a>
                <a class="upvote" href="#">Upvote</a>
                {% endcomment %}
            </h2>
            {% with project.user.get_profile as profile %}
            <div class="userinfo">
                <a href="{% url 'profile' project.user.username %}">
                    {% avatar profile 35 %}
                </a> Written by:
                <a href="{% url 'profile' project.user.username %}">{{ project.user.username }}</a>
            </div>
            {% endwith %}
        </header>
    </div>
</div>


    <div class="steps-timeline row">
        <div class="span12">
            <hr />
            <ul>
                <li><a href="#overview">Overview</a></li>
                {% for step in project.steps.all %}
                <li><a href="#step{{ forloop.counter }}">{{ forloop.counter }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="overview row">
        {% if project.featured_video or project.featured_photo %}
        <div class="span7">
            {{ project.tldr|safe }}
            <p class="categories">
                <strong>Categories:</strong>
                {% for category in project.categories.all %}
                    {{ category.title }}
                {% endfor %}
            </p>
        </div>
        <div class="featured span5">
        {# Intro Video #}
            {% if project.featured_video %}
                <div id="VideoDiv">
                    {# Use if flash not located #}
                    <iframe type="text/html" width="100%" height="250"
                            src="{{ project.embed_url }}"
                            frameborder="0">
                    </iframe>
                </div>
            {% elif project.featured_photo %}
                <img src="{{ MEDIA_URL }}{% thumbnail project.featured_photo.url 600 400 %}" alt="{{ project.featured_photo.slug }}">
            {% endif %}
        </div>
        {% else %}
        <div class="span12">
            {{ project.tldr|safe }}
            <p class="categories">
                <strong>Categories:</strong>
                {% for category in project.categories.all %}
                    {{ category.title }}
                {% endfor %}
            </p>
        </div>
        {% endif %}
    </div>

    {% for step in project.steps.all %}
    <div id="step{{ forloop.counter }}" class="steps">
        <div class="row">
            <div class="span12">
                <h3>Step {{ forloop.counter }}
                    {% if request.user == project.user or request.user.is_superuser %}
                        <a href="{% url 'project-step-create-edit' project.slug step.order %}"><i class="icon-edit icon-white"></i> Edit Step</a>
                        <a href="{% url 'project-step-delete' step.id %}"><i class="icon-trash btn-danger icon-white"></i> Delete Step</a>
                    {% endif %}
                </h3>
                {# FIXME: Determine the whitelist of html tags and assure this won't break the page #}
                {{ step.content|safe }}
            </div>
        </div>
        {% if step.video %}
        <div class="row">
            <div class="span12">
                <div id="videoDiv{{ forloop.counter}}">
                 {# Use if flash not located #}
                 <iframe type="text/html" width="50%" height="300"
                         src="{{ step.embed_url }}"
                         frameborder="0">
                 </iframe>
                </div>
            </div>
        </div>
        {% endif %}
        {% if step.gallery.all %}
        <div class="row">
            <div class="gallery-display span12">
                <div class="gallery">
                    {% if step.gallery.count > 1 %}
                    <div class="swipe" id="slider{{ forloop.counter }}">
                        <ul class="swipe-wrap">
                            {% include 'includes/step-gallery.html' %}
                        </ul>
                    </div>
                    <nav>
                        <a onclick="swipes[{{ forloop.counter0 }}].prev()" id="prev" href="javascript:void(0)"><</a>
                        <a onclick="swipes[{{ forloop.counter0 }}].next()" id="next" href="javascript:void(0)">></a>
                    </nav>
                    {% else %}
                    <ul class="no-swipe">
                        {% include 'includes/step-gallery.html' %}
                    </ul>
                    {% endif %}
                </div>
                <ul class="tiled">
                    {% include 'includes/step-gallery.html' %}
                </ul>
            </div>
        </div>
    {% endif %}
    {% endfor %}
{% endblock %}

{% block extra_js %}
    {# JS for slider gallery, works if there are multiple swipping galleries. #}
    <script src="{{ STATIC_URL }}js/libs/swipe.js"></script>
    <script>

    var swipes = []
    $('.swipe').each(function(i, obj) {
            swipes[i] = new Swipe(obj);
        });

    </script>

    <script src="{{ STATIC_URL }}js/libs/google_jsapi.js" type="text/javascript"></script>
    {% if project.featured_video %}
        <script type="text/javascript">
            google.load("swfobject", "2.1");
            function _run() {
                var videoID = "{{ project.video_id }}";
                var params = { allowScriptAccess: "always" };
                var atts = { id: "ytPlayer" };
                swfobject.embedSWF("http://www.youtube.com/v/" + videoID + "?version=3&enablejsapi=1&playerapiid=player1", "videoDiv", "100%", "350", "9", null, null, params, atts);
            };
            google.setOnLoadCallback(_run);
        </script>
    {% endif %}
    {% for step in project.steps.all %}
        {% if step.video %}
        <script type="text/javascript">
            google.load("swfobject", "2.1");
            function _run() {
                var videoID = "{{ step.video_id }}";
                var params = { allowScriptAccess: "always" };
                var atts = { id: "ytPlayer" };
                swfobject.embedSWF("http://www.youtube.com/v/" + videoID + "?version=3&enablejsapi=1&playerapiid=player1", "videoDiv{{ forloop.counter }}", "100%", "350", "9", null, null, params, atts);
            };
            google.setOnLoadCallback(_run);
        </script>
        {% endif %}
    {% endfor %}
    <script type="text/javascript">
        var publish_project_url = "{% url 'publish-project' project.slug %}"
        $(function() {
            var $publish_project = $('#publish-project'),
                $publish = $('#publish');
            $publish_project.click(function(){
                $.post(publish_project_url, function(data) {
                    $publish_project.fadeOut();
                    $publish.children('h4')
                            .html('w00t! This project is now published.')
                            .addClass('done');
                    $publish.delay(1000).fadeOut();
                });
            });
        });
    </script>
{% endblock %}
