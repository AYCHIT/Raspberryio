{% extends "base.html" %}
{% load mezzanine_tags %}
{% load url from future %}

{% block main %}
    {% if not project.is_published %}
        {% if request.user == project.user or request.user.is_superuser %}
            <div id='publish'>
                <h2>This project is saved as a draft.</h2>
                <a id='publish-project' href="#">Click here to publish</a>
            </div>
        {% endif %}
    {% endif %}
    <h3>
        {{ project.title }}
    </h3>
    {# Intro Video #}
    {% if project.featured_video %}
        <div id="VideoDiv">
            {# Use if flash not located #}
            <iframe type="text/html" width="540" height="345"
                    src="{{ project.embed_url }}"
                    frameborder="0">
            </iframe>
        </div>
    {% endif %}
    Categories
    <ul>
        {% for category in project.categories.all %}
            <li class="category">
                {{ category.title }}
            </li>
        {% endfor %}
    </ul>
    {{ project.tldr|safe }}
    {% for step in project.steps.all %}
        {# hr for quick sanity check on steps #}
        <hr />
        <h3>Step {{ forloop.counter }}</h3>
        {% if step.video %}
            <div id="videoDiv{{ forloop.counter}}">
                {# Use if flash not located #}
                <iframe type="text/html" width="540" height="345"
                        src="{{ step.embed_url }}"
                        frameborder="0">
                </iframe>
            </div>
        {% endif %}
        {# TODO: Show the gallery with a nice slideshow "widget" #}
        {% if step.gallery %}
            {% for photo in step.gallery.all %}
                <img src="{{ MEDIA_URL }}{% thumbnail photo.file.url 250 250 %}" />
            {% endfor %}
        {% endif %}
        {# FIXME: Determine the whitelist of html tags and assure this won't break the page #}
        {{ step.content|safe }}
    {% endfor %}
    {% if request.user == project.user or request.user.is_superuser %}
        <a href="{% url 'project-create-edit' project.slug %}">Edit Project</a>
    {% endif %}
{% endblock %}

{% block extra_js %}
    <script src="{{ STATIC_URL }}js/libs/google_jsapi.js" type="text/javascript"></script>
    {% if project.featured_video %}
        <script type="text/javascript">
            google.load("swfobject", "2.1");
            function _run() {
                var videoID = "{{ project.video_id }}";
                var params = { allowScriptAccess: "always" };
                var atts = { id: "ytPlayer" };
                swfobject.embedSWF("http://www.youtube.com/v/" + videoID + "?version=3&enablejsapi=1&playerapiid=player1", "videoDiv", "480", "295", "9", null, null, params, atts);
            };
            google.setOnLoadCallback(_run);
        </script>
    {% endif %}
    {% for step in project.steps.all %}
        {% if step.video %}
        <script type="text/javascript">
            google.load("swfobject", "2.1");
            function _run() {
                var videoID = "{{ step.video_id }}";
                var params = { allowScriptAccess: "always" };
                var atts = { id: "ytPlayer" };
                swfobject.embedSWF("http://www.youtube.com/v/" + videoID + "?version=3&enablejsapi=1&playerapiid=player1", "videoDiv{{ forloop.counter }}", "480", "295", "9", null, null, params, atts);
            };
            google.setOnLoadCallback(_run);
        </script>
        {% endif %}
    {% endfor %}
    <script type="text/javascript">
        var publish_project_url = "{% url 'publish-project' project.slug %}"
        $(function() {
            var $publish_project = $('#publish-project'),
                $publish = $('#publish');
            $publish_project.click(function(){
                $.post(publish_project_url, function(data) {
                    $publish_project.fadeOut();
                    $publish.children('h2')
                            .html('This project is now published');
                });
            });
        });
    </script>
{% endblock %}
